<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World News Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root {
            --sidebar-width: 400px;
            --toggle-width: 30px;
            --sidebar-bg: rgba(249, 249, 249, 0.94);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --tab-height: 42px;
            --tab-bg: #f3f3f3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #fafafa;
        }

        .layout {
            position: relative;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .overlay-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }

        #sidebar {
            position: absolute;
            top: 12px;
            bottom: 12px;
            width: var(--sidebar-width);
            overflow-y: auto;
            background: var(--sidebar-bg);
            padding: 12px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid #e5e5e5;
            box-shadow: var(--shadow);
            pointer-events: auto;
        }

        #sidebar {
            right: var(--toggle-width);
        }

        #sidebar.collapsed {
            transform: translateX(calc(100% + var(--toggle-width)));
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 12px;
            width: var(--toggle-width);
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-size: 16px;
            background: #f0f0f0;
            border: 1px solid #e5e5e5;
            box-shadow: var(--shadow);
            transition: background 0.2s ease;
            pointer-events: auto;
            z-index: 3;
        }

        .sidebar-toggle {
            right: 6px;
        }

        .sidebar-toggle:hover {
            background: #e0e0e0;
        }

        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
            height: var(--tab-height);
        }

        .tab-btn {
            border: 1px solid #dcdcdc;
            background: var(--tab-bg);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: #fff;
            border-color: #c0c0c0;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .sidebar-header {
            font-weight: 600;
            font-size: 14px;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #d0d0d0;
            color: #333;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #e6e6e6;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .news-item:hover {
            background: #f0f0f0;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 6px 0;
            line-height: 1.4;
        }

        .news-time {
            font-size: 12px;
            color: #999;
            margin: 0 0 6px 0;
        }

        .news-links {
            font-size: 12px;
        }

        .news-links a {
            display: inline-block;
            margin-right: 8px;
            color: #0066cc;
            text-decoration: none;
        }

        .news-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="layout">
        <div id="map"></div>
        <div class="overlay-container">
            <div class="sidebar-toggle" id="toggle-btn">«</div>
            <div id="sidebar">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="other">Other News</button>
                    <button class="tab-btn" data-tab="all">News List</button>
                </div>
                <div class="tab-panel active" id="tab-other"></div>
                <div class="tab-panel" id="tab-all"></div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);
        const markerMap = new Map();

        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-btn');
        const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
        const tabPanels = {
            other: document.getElementById('tab-other'),
            all: document.getElementById('tab-all'),
        };
        let sidebarCollapsed = false;

        toggleBtn.addEventListener('click', () => {
            sidebarCollapsed = !sidebarCollapsed;
            sidebar.classList.toggle('collapsed');
            toggleBtn.textContent = sidebarCollapsed ? '»' : '«';
            map.invalidateSize();
        });

        tabButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                tabButtons.forEach((b) => b.classList.toggle('active', b === btn));
                Object.entries(tabPanels).forEach(([key, panel]) => {
                    panel.classList.toggle('active', key === tab);
                });
            });
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getLastSevenDates() {
            const dates = [];
            const now = new Date();
            for (let i = 0; i < 7; i += 1) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                dates.push(formatDate(d));
            }
            return dates;
        }

        function isValidCoordinate(coord) {
            if (!coord) return false;
            const lat = Number(coord.latitude);
            const lon = Number(coord.longitude);
            if (lat === null || lon === null || lat === undefined || lon === undefined) {
                return false;
            }
            if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
            if (lat === -1 && lon === -1) return false;
            return true;
        }

        function buildLinksHtml(links) {
            if (!Array.isArray(links) || links.length === 0) return '';
            return links.map((item) => {
                const label = item.source;
                return `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
            }).join('');
        }

        function createNewsCard(item, onClickCallback) {
            const card = document.createElement('div');
            card.className = 'news-item';
            const title = item.description;
            const time = item.date || '';
            const linksHtml = buildLinksHtml(item.links);

            card.innerHTML = `
                <div class="news-title">${title}</div>
                <div class="news-time">${time}</div>
                <div class="news-links">${linksHtml}</div>
            `;

            if (onClickCallback) {
                card.addEventListener('click', () => onClickCallback(item));
            }

            return card;
        }

        function buildPopupHtml(itemsAtPoint) {
            const lines = itemsAtPoint.map((it) => {
                const linksHtml = buildLinksHtml(it.links);
                const time = it.date || '';
                return `<div style="margin-bottom:10px;">
                    <div><strong>${it.description}</strong></div>
                    <div style="color:#777;font-size:12px;">${time}</div>
                    <div class="news-links">${linksHtml}</div>
                </div>`;
            }).join('');
            return `<div style="max-width:300px;">${lines}</div>`;
        }

        function focusOnMarker(item) {
            if (!isValidCoordinate(item.coordinate)) return;
            const lat = Number(item.coordinate.latitude);
            const lon = Number(item.coordinate.longitude);
            map.setView([lat, lon], 10);

            const key = `${lat},${lon}`;
            if (markerMap.has(key)) {
                markerMap.get(key).openPopup();
            }
        }

        async function fetchNews() {
            tabPanels.other.innerHTML = '<div class="sidebar-header">Other News</div>';
            tabPanels.all.innerHTML = '<div class="sidebar-header">News List</div>';
            markersLayer.clearLayers();
            markerMap.clear();

            const dates = getLastSevenDates();
            const allItems = [];

            await Promise.all(dates.map(async (date) => {
                const url = `./news/${date}.json?t=${Date.now()}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return;
                    const dayItems = await response.json();
                    if (Array.isArray(dayItems)) {
                        allItems.push(...dayItems);
                    }
                } catch (error) {
                    console.error(`Failed to fetch news for ${date}:`, error);
                }
            }));

            const noCoordinateItems = [];
            const groupedByCoordinate = new Map();

            allItems.forEach((item) => {
                const status = item.status || 'unknown';

                if (status === 'no_valid_coordinate') {
                    noCoordinateItems.push(item);
                } else if (status === 'coordinate_fetched') {
                    if (isValidCoordinate(item.coordinate)) {
                        const lat = Number(item.coordinate.latitude);
                        const lon = Number(item.coordinate.longitude);
                        const key = `${lat},${lon}`;
                        if (!groupedByCoordinate.has(key)) {
                            groupedByCoordinate.set(key, []);
                        }
                        groupedByCoordinate.get(key).push(item);
                    } else {
                        noCoordinateItems.push(item);
                    }
                }
            });

            groupedByCoordinate.forEach((itemsAtPoint, key) => {
                const [lat, lon] = key.split(',').map(Number);
                const popupHtml = buildPopupHtml(itemsAtPoint);
                const marker = L.marker([lat, lon]).addTo(markersLayer).bindPopup(popupHtml);
                markerMap.set(key, marker);
            });

            noCoordinateItems.forEach((item) => {
                tabPanels.other.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (noCoordinateItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = 'No News Here';
                tabPanels.other.appendChild(emptyMsg);
            }

            const validCoordinateItems = Array.from(groupedByCoordinate.values()).flat();
            const allFilteredItems = [...noCoordinateItems, ...validCoordinateItems];
            allFilteredItems.sort((a, b) => new Date(b.date) - new Date(a.date));

            allFilteredItems.forEach((item) => {
                tabPanels.all.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (allFilteredItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = 'No News Here';
                tabPanels.all.appendChild(emptyMsg);
            }
        }

        fetchNews();
    </script>
</body>

</html>