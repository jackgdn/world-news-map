<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World News Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css" />
    <style>
        :root {
            --sidebar-width: 400px;
            --toggle-width: 30px;
            --sidebar-bg: rgba(249, 249, 249, 0.94);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --tab-height: 42px;
            --tab-bg: #f3f3f3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #fafafa;
        }

        .layout {
            position: relative;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .overlay-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }

        #sidebar {
            position: absolute;
            top: 10px;
            bottom: 46px;
            width: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
            padding: 12px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid #e5e5e5;
            box-shadow: var(--shadow);
            pointer-events: auto;
        }

        #sidebar {
            right: calc(var(--toggle-width) + 20px);
        }

        #sidebar.collapsed {
            transform: translateX(calc(100% + var(--toggle-width)));
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 10px;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            background: #f0f0f0;
            border: 1px solid #e5e5e5;
            border-radius: 50%;
            box-shadow: var(--shadow);
            transition: background 0.2s ease;
            pointer-events: auto;
            z-index: 3;
        }

        .sidebar-toggle {
            right: 6px;
        }

        .sidebar-toggle:hover {
            background: #e0e0e0;
        }

        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
            height: var(--tab-height);
        }

        .tab-btn {
            border: 1px solid #dcdcdc;
            background: var(--tab-bg);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-update {
            font-size: 11px;
            color: #777;
            white-space: nowrap;
            font-weight: 400;
            margin-left: 6px;
        }

        .tab-btn.active {
            background: #fff;
            border-color: #c0c0c0;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .sidebar-body {
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-footer {
            margin-top: 10px;
            font-size: 12px;
            color: #555;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 8px 10px;
            line-height: 1.4;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .sidebar-header {
            font-weight: 600;
            font-size: 14px;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #d0d0d0;
            color: #333;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #e6e6e6;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .news-item:hover {
            background: #f0f0f0;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 6px 0;
            line-height: 1.4;
        }

        .news-time {
            font-size: 12px;
            color: #999;
            margin: 0 0 6px 0;
        }

        .news-links {
            font-size: 12px;
        }

        .news-links a {
            display: inline-block;
            margin-right: 8px;
            color: #0066cc;
            text-decoration: none;
        }

        .news-links a:hover {
            text-decoration: underline;
        }

        .ol-popup {
            position: absolute;
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            max-height: 260px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.16);
            padding: 10px;
            pointer-events: auto;
        }

        .ol-attribution {
            background: rgba(255, 255, 255, 0.94) !important;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }

        .ol-attribution ul {
            margin: 0 6px;
            padding: 2px 0;
        }

        .ol-attribution li {
            color: #333;
        }

        .ol-attribution a {
            color: #1f4fa3;
            text-decoration: none;
            font-weight: 500;
        }

        .ol-attribution a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="layout">
        <div id="map"></div>
        <div id="marker-popup" class="ol-popup" style="display:none;"></div>
        <div class="overlay-container">
            <div class="sidebar-toggle" id="toggle-btn">«</div>
            <div id="sidebar">
                <div class="sidebar-body">
                    <div class="tabs">
                        <button class="tab-btn" data-tab="other">Other News</button>
                        <button class="tab-btn active" data-tab="all">News List</button>
                    </div>
                    <div class="tab-panel" id="tab-other"></div>
                    <div class="tab-panel active" id="tab-all"></div>
                </div>
                <div class="sidebar-footer">
                    Content partially sourced from Wikipedia “Portal: Current events”
                    (<a href="https://en.wikipedia.org/wiki/Portal:Current_events" target="_blank"
                        rel="noopener noreferrer">link</a>),
                    authors: Wikipedia contributors, licensed under
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank"
                        rel="noopener noreferrer">CC BY-SA 4.0</a>.
                    Adaptations (if any) have been made.
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script>
        const attributionText = '<a href="https://www.openstreetmap.org/fixthemap" target="_blank" rel="noopener noreferrer">Report a map issue</a> | ' +
            '© OpenStreetMap contributors, ASTER GDEM, EarthEnv-DEM90, CDEM contains information under OGL Canada';

        const vectorSource = new ol.source.Vector();
        const markersLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({ color: '#2a70d6' }),
                    stroke: new ol.style.Stroke({ color: '#ffffff', width: 1.5 }),
                }),
            }),
        });

        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://tile.osm.ch/switzerland/{z}/{x}/{y}.png',
                        maxZoom: 19,
                        attributions: [attributionText],
                    }),
                }),
                markersLayer,
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: 2,
            }),
            controls: ol.control.defaults.defaults({
                zoom: false,
                rotate: false,
                attribution: true,
            }),
        });

        const popupElement = document.getElementById('marker-popup');
        const popupOverlay = new ol.Overlay({
            element: popupElement,
            positioning: 'bottom-center',
            offset: [0, -12],
            stopEvent: true,
        });
        map.addOverlay(popupOverlay);

        function closePopup() {
            popupOverlay.setPosition(undefined);
            popupElement.style.display = 'none';
        }

        function openPopup(html, lon, lat) {
            popupElement.innerHTML = html;
            popupElement.style.display = 'block';
            popupOverlay.setPosition(ol.proj.fromLonLat([lon, lat]));
        }

        map.on('singleclick', (event) => {
            const feature = map.forEachFeatureAtPixel(event.pixel, (foundFeature) => foundFeature);
            if (!feature) {
                closePopup();
                return;
            }

            const popupHtml = feature.get('popupHtml') || '';
            const lon = Number(feature.get('longitude'));
            const lat = Number(feature.get('latitude'));
            if (!Number.isFinite(lon) || !Number.isFinite(lat)) {
                closePopup();
                return;
            }

            openPopup(popupHtml, lon, lat);
        });

        map.on('pointermove', (event) => {
            if (event.dragging) return;
            const hasFeature = map.hasFeatureAtPixel(event.pixel);
            map.getTargetElement().style.cursor = hasFeature ? 'pointer' : '';
        });

        const markerMap = new Map();

        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-btn');
        const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
        const tabPanels = {
            other: document.getElementById('tab-other'),
            all: document.getElementById('tab-all'),
        };
        let lastUpdateValue = '--';
        let lastUpdateParsedDate = null;
        let sidebarCollapsed = false;

        toggleBtn.addEventListener('click', () => {
            sidebarCollapsed = !sidebarCollapsed;
            sidebar.classList.toggle('collapsed');
            toggleBtn.textContent = sidebarCollapsed ? '»' : '«';
            map.updateSize();
        });

        tabButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                tabButtons.forEach((b) => b.classList.toggle('active', b === btn));
                Object.entries(tabPanels).forEach(([key, panel]) => {
                    panel.classList.toggle('active', key === tab);
                });
            });
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatLocalDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }

        function formatTimezoneLabel(date) {
            const offsetMinutes = -date.getTimezoneOffset();
            const sign = offsetMinutes >= 0 ? '+' : '-';
            const absoluteMinutes = Math.abs(offsetMinutes);
            const hours = String(Math.floor(absoluteMinutes / 60)).padStart(2, '0');
            const minutes = String(absoluteMinutes % 60).padStart(2, '0');
            return `UTC${sign}${hours}:${minutes}`;
        }

        function formatRelativeTime(date) {
            const diffMs = Date.now() - date.getTime();
            if (!Number.isFinite(diffMs)) return '';

            if (diffMs < 60 * 1000) {
                return 'just updated';
            }

            const minutes = Math.floor(diffMs / (60 * 1000));
            if (minutes < 60) {
                return `${minutes} minutes ago`;
            }

            const hours = Math.floor(diffMs / (60 * 60 * 1000));
            if (hours < 24) {
                return `${hours} hours ago`;
            }

            const days = Math.floor(diffMs / (24 * 60 * 60 * 1000));
            return `${days} days ago`;
        }

        function getLastSevenDates() {
            const dates = [];
            const now = new Date();
            for (let i = 0; i < 7; i += 1) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                dates.push(formatDate(d));
            }
            return dates;
        }

        function isValidCoordinate(coord) {
            if (!coord) return false;
            const lat = Number(coord.latitude);
            const lon = Number(coord.longitude);
            if (lat === null || lon === null || lat === undefined || lon === undefined) {
                return false;
            }
            if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
            if (lat === -1 && lon === -1) return false;
            return true;
        }

        function buildLinksHtml(links) {
            if (!Array.isArray(links) || links.length === 0) return '';
            return links.map((item) => {
                const label = item.source;
                return `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
            }).join('');
        }

        function createNewsCard(item, onClickCallback) {
            const card = document.createElement('div');
            card.className = 'news-item';
            const title = item.description;
            const time = item.date || '';
            const linksHtml = buildLinksHtml(item.links);

            card.innerHTML = `
                <div class="news-title">${title}</div>
                <div class="news-time">${time}</div>
                <div class="news-links">${linksHtml}</div>
            `;

            if (onClickCallback) {
                card.addEventListener('click', () => onClickCallback(item));
            }

            return card;
        }

        function buildPopupHtml(itemsAtPoint) {
            const sorted = [...itemsAtPoint].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            const lines = sorted.map((it) => {
                const linksHtml = buildLinksHtml(it.links);
                const time = it.date || '';
                return `<div class="news-item">
                    <div class="news-title">${it.description}</div>
                    <div class="news-time">${time}</div>
                    <div class="news-links">${linksHtml}</div>
                </div>`;
            }).join('');
            return `<div>${lines}</div>`;
        }

        function focusOnMarker(item) {
            if (!isValidCoordinate(item.coordinate)) return;
            const lat = Number(item.coordinate.latitude);
            const lon = Number(item.coordinate.longitude);
            map.getView().animate({
                center: ol.proj.fromLonLat([lon, lat]),
                zoom: 10,
                duration: 250,
            });

            const key = `${lat},${lon}`;
            if (markerMap.has(key)) {
                const markerInfo = markerMap.get(key);
                openPopup(markerInfo.popupHtml, markerInfo.longitude, markerInfo.latitude);
            }
        }

        function renderTabHeaders() {
            tabPanels.other.innerHTML = `<div class="sidebar-header">Other News <span class="header-update">Last Update: ${lastUpdateValue}</span></div>`;
            tabPanels.all.innerHTML = `<div class="sidebar-header">News List <span class="header-update">Last Update: ${lastUpdateValue}</span></div>`;
        }

        function refreshLastUpdateDisplay() {
            if (!lastUpdateParsedDate) {
                return;
            }

            const timezoneLabel = formatTimezoneLabel(lastUpdateParsedDate);
            const localText = formatLocalDateTime(lastUpdateParsedDate);
            const relativeText = formatRelativeTime(lastUpdateParsedDate);
            lastUpdateValue = `${timezoneLabel} ${localText} (${relativeText})`;
            renderTabHeaders();
        }

        function setLastUpdateText(value) {
            const raw = (value || '').trim();
            if (!raw) {
                lastUpdateValue = '--';
                lastUpdateParsedDate = null;
                renderTabHeaders();
                return;
            }

            const parsed = new Date(raw);
            if (Number.isNaN(parsed.getTime())) {
                lastUpdateValue = raw;
                lastUpdateParsedDate = null;
                renderTabHeaders();
                return;
            }

            lastUpdateParsedDate = parsed;
            refreshLastUpdateDisplay();
        }

        async function fetchLastUpdateFromSecurityTxt() {
            try {
                const response = await fetch(`./.well-known/security.txt`);
                if (!response.ok) {
                    setLastUpdateText('');
                    return;
                }

                const text = await response.text();
                const lines = text.split(/\r?\n/);
                const secondLine = (lines[1] || '').trim();
                const matched = secondLine.match(/^#\s*Generated on\s+(.+)$/i);

                if (matched && matched[1]) {
                    setLastUpdateText(matched[1].trim());
                    return;
                }

                setLastUpdateText('');
            } catch (error) {
                console.error('Failed to fetch last update from security.txt:', error);
                setLastUpdateText('');
            }
        }

        async function fetchNews() {
            renderTabHeaders();
            vectorSource.clear();
            markerMap.clear();
            closePopup();

            const dates = getLastSevenDates();
            const allItems = [];

            await Promise.all(dates.map(async (date) => {
                const url = `./news/${date}.json`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return;
                    const dayItems = await response.json();
                    if (Array.isArray(dayItems)) {
                        allItems.push(...dayItems);
                    }
                } catch (error) {
                    console.error(`Failed to fetch news for ${date}:`, error);
                }
            }));

            const noCoordinateItems = [];
            const groupedByCoordinate = new Map();

            allItems.forEach((item) => {
                const status = item.status || 'unknown';

                if (status === 'no_valid_coordinate') {
                    noCoordinateItems.push(item);
                } else if (status === 'coordinate_fetched') {
                    if (isValidCoordinate(item.coordinate)) {
                        const lat = Number(item.coordinate.latitude);
                        const lon = Number(item.coordinate.longitude);
                        const key = `${lat},${lon}`;
                        if (!groupedByCoordinate.has(key)) {
                            groupedByCoordinate.set(key, []);
                        }
                        groupedByCoordinate.get(key).push(item);
                    } else {
                        noCoordinateItems.push(item);
                    }
                }
            });

            groupedByCoordinate.forEach((itemsAtPoint, key) => {
                const [lat, lon] = key.split(',').map(Number);
                const popupHtml = buildPopupHtml(itemsAtPoint);
                const markerFeature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
                });
                markerFeature.set('popupHtml', popupHtml);
                markerFeature.set('latitude', lat);
                markerFeature.set('longitude', lon);
                vectorSource.addFeature(markerFeature);

                markerMap.set(key, {
                    popupHtml,
                    latitude: lat,
                    longitude: lon,
                });
            });

            noCoordinateItems.forEach((item) => {
                tabPanels.other.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (noCoordinateItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = 'No News Here';
                tabPanels.other.appendChild(emptyMsg);
            }

            const validCoordinateItems = Array.from(groupedByCoordinate.values()).flat();
            const allFilteredItems = [...noCoordinateItems, ...validCoordinateItems];
            allFilteredItems.sort((a, b) => new Date(b.date) - new Date(a.date));

            allFilteredItems.forEach((item) => {
                tabPanels.all.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (allFilteredItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = 'No News Here';
                tabPanels.all.appendChild(emptyMsg);
            }
        }

        (async () => {
            await fetchLastUpdateFromSecurityTxt();
            await fetchNews();
        })();

    </script>
</body>

</html>