<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World News Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .layout {
            display: flex;
            height: 100vh;
        }

        #sidebar-left {
            width: 360px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 12px;
            border-right: 1px solid #e5e5e5;
            transition: transform 0.3s ease, width 0.3s ease;
            flex-shrink: 0;
        }

        #sidebar-left.collapsed {
            transform: translateX(-100%);
            width: 0;
            padding: 0;
            border: none;
        }

        .sidebar-toggle-left {
            position: absolute;
            left: 0;
            width: 30px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-right: 1px solid #e5e5e5;
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            transition: background 0.2s ease;
            z-index: 1000;
        }

        .sidebar-toggle-left:hover {
            background: #e0e0e0;
        }

        #map {
            flex: 1 1 auto;
            margin-left: 30px;
        }

        #map.sidebar-left-collapsed {
            margin-left: 0;
        }

        .sidebars-right-container {
            display: flex;
        }

        #sidebar-right {
            width: 360px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 12px;
            border-left: 1px solid #e5e5e5;
            transition: transform 0.3s ease, width 0.3s ease;
            flex-shrink: 0;
        }

        #sidebar-right.collapsed {
            transform: translateX(100%);
            width: 0;
            padding: 0;
            border: none;
        }

        .sidebar-toggle-right {
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-left: 1px solid #e5e5e5;
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            transition: background 0.2s ease;
        }

        .sidebar-toggle-right:hover {
            background: #e0e0e0;
        }

        .sidebar-header {
            font-weight: 600;
            font-size: 14px;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #d0d0d0;
            color: #333;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #e6e6e6;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .news-item:hover {
            background: #f0f0f0;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 6px 0;
            line-height: 1.4;
        }

        .news-time {
            font-size: 12px;
            color: #999;
            margin: 0 0 6px 0;
        }

        .news-links {
            font-size: 12px;
        }

        .news-links a {
            display: inline-block;
            margin-right: 8px;
            color: #0066cc;
            text-decoration: none;
        }

        .news-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="layout">
        <div class="sidebar-toggle-left" id="toggle-btn-left">«</div>
        <div id="sidebar-left"></div>
        <div id="map"></div>
        <div class="sidebars-right-container">
            <div id="sidebar-right"></div>
            <div class="sidebar-toggle-right" id="toggle-btn-right">»</div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);
        const markerMap = new Map(); // 用于存储坐标对应的 marker

        const sidebarLeft = document.getElementById('sidebar-left');
        const sidebarRight = document.getElementById('sidebar-right');
        const toggleBtnLeft = document.getElementById('toggle-btn-left');
        const toggleBtnRight = document.getElementById('toggle-btn-right');
        const mapElement = document.getElementById('map');
        let leftCollapsed = false;
        let rightCollapsed = false;

        // 左侧侧边栏折叠/展开
        toggleBtnLeft.addEventListener('click', () => {
            leftCollapsed = !leftCollapsed;
            sidebarLeft.classList.toggle('collapsed');
            mapElement.classList.toggle('sidebar-left-collapsed');
            toggleBtnLeft.textContent = leftCollapsed ? '»' : '«';
            map.invalidateSize();
        });

        // 右侧侧边栏折叠/展开
        toggleBtnRight.addEventListener('click', () => {
            rightCollapsed = !rightCollapsed;
            sidebarRight.classList.toggle('collapsed');
            toggleBtnRight.textContent = rightCollapsed ? '«' : '»';
            map.invalidateSize();
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getLastSevenDates() {
            const dates = [];
            const now = new Date();
            for (let i = 0; i < 7; i += 1) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                dates.push(formatDate(d));
            }
            return dates;
        }

        function isValidCoordinate(coord) {
            if (!coord) return false;
            const lat = Number(coord.latitude);
            const lon = Number(coord.longitude);
            if (lat === null || lon === null || lat === undefined || lon === undefined) {
                return false;
            }
            if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
            if (lat === -1 && lon === -1) return false;
            return true;
        }

        function buildLinksHtml(links) {
            if (!Array.isArray(links) || links.length === 0) return '';
            return links.map((item) => {
                const label = item.source;
                return `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
            }).join('');
        }

        function createNewsCard(item, onClickCallback) {
            const card = document.createElement('div');
            card.className = 'news-item';
            const title = item.description;
            const time = item.date || '';
            const linksHtml = buildLinksHtml(item.links);

            card.innerHTML = `
                <div class="news-title">${title}</div>
                <div class="news-time">${time}</div>
                <div class="news-links">${linksHtml}</div>
            `;

            if (onClickCallback) {
                card.addEventListener('click', () => onClickCallback(item));
            }

            return card;
        }

        function focusOnMarker(item) {
            if (isValidCoordinate(item.coordinate)) {
                const lat = Number(item.coordinate.latitude);
                const lon = Number(item.coordinate.longitude);
                map.setView([lat, lon], 10);

                // 高亮对应的 marker
                const key = `${lat},${lon}`;
                if (markerMap.has(key)) {
                    markerMap.get(key).openPopup();
                }
            }
        }

        async function fetchNews() {
            sidebarLeft.innerHTML = '<div class="sidebar-header">无法定位的新闻</div>';
            sidebarRight.innerHTML = '<div class="sidebar-header">所有新闻</div>';
            markersLayer.clearLayers();
            markerMap.clear();

            const dates = getLastSevenDates();
            const allItems = [];

            await Promise.all(dates.map(async (date) => {
                const url = `../../../news/${date}.json?t=${Date.now()}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return;
                    const dayItems = await response.json();
                    if (Array.isArray(dayItems)) {
                        allItems.push(...dayItems);
                    }
                } catch (error) {
                    console.error(`Failed to fetch news for ${date}:`, error);
                }
            }));

            // 过滤并分类新闻
            const noCoordinateItems = [];
            const validCoordinateItems = [];

            allItems.forEach((item) => {
                const status = item.status || 'unknown';

                // 只展示指定状态的新闻
                if (status === 'no_valid_coordinate') {
                    noCoordinateItems.push(item);
                } else if (status === 'coordinate_fetched') {
                    if (isValidCoordinate(item.coordinate)) {
                        validCoordinateItems.push(item);
                    } else {
                        noCoordinateItems.push(item);
                    }
                }
            });

            // 在地图上显示有效坐标的新闻
            validCoordinateItems.forEach((item) => {
                const lat = Number(item.coordinate.latitude);
                const lon = Number(item.coordinate.longitude);
                const title = item.description;
                const time = item.date || '';
                const linksHtml = buildLinksHtml(item.links);
                const popupHtml = `<div><div><strong>${title}</strong></div><div>${time}</div><div class="news-links">${linksHtml}</div></div>`;
                const marker = L.marker([lat, lon]).addTo(markersLayer).bindPopup(popupHtml);
                markerMap.set(`${lat},${lon}`, marker);
            });

            // 左侧侧边栏：无法定位的新闻
            noCoordinateItems.forEach((item) => {
                sidebarLeft.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (noCoordinateItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = '没有无法定位的新闻';
                sidebarLeft.appendChild(emptyMsg);
            }

            // 右侧侧边栏：所有新闻，按日期排序
            const allFilteredItems = [...noCoordinateItems, ...validCoordinateItems];
            allFilteredItems.sort((a, b) => new Date(b.date) - new Date(a.date));

            allFilteredItems.forEach((item) => {
                sidebarRight.appendChild(createNewsCard(item, focusOnMarker));
            });

            if (allFilteredItems.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'color: #999; font-size: 12px; padding: 20px 0;';
                emptyMsg.textContent = '没有新闻数据';
                sidebarRight.appendChild(emptyMsg);
            }
        }

        fetchNews();
        setInterval(fetchNews, 3600000);
    </script>
</body>

</html>