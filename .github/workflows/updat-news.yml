name: Update News

on:
    schedule:
        - cron: "0 6,18 * * *"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    run-main:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate required secrets
              env:
                  CONTACT_INFO: ${{ secrets.CONTACT_INFO }}
                  LANGUAGE_MODEL_BASE_URL: ${{ secrets.LANGUAGE_MODEL_BASE_URL }}
                  LANGUAGE_MODEL_NAME: ${{ secrets.LANGUAGE_MODEL_NAME }}
                  LANGUAGE_MODEL_API_KEY: ${{ secrets.LANGUAGE_MODEL_API_KEY }}
              run: |
                  echo "CONTACT_INFO length: ${#CONTACT_INFO}"
                  echo "LANGUAGE_MODEL_BASE_URL length: ${#LANGUAGE_MODEL_BASE_URL}"
                  echo "LANGUAGE_MODEL_NAME length: ${#LANGUAGE_MODEL_NAME}"
                  echo "LANGUAGE_MODEL_API_KEY length: ${#LANGUAGE_MODEL_API_KEY}"
                  [ -z "$CONTACT_INFO" ] && echo "Missing CONTACT_INFO" && exit 1
                  [ -z "$LANGUAGE_MODEL_BASE_URL" ] && echo "Missing LANGUAGE_MODEL_BASE_URL" && exit 1
                  [ -z "$LANGUAGE_MODEL_NAME" ] && echo "Missing LANGUAGE_MODEL_NAME" && exit 1
                  [ -z "$LANGUAGE_MODEL_API_KEY" ] && echo "Missing LANGUAGE_MODEL_API_KEY" && exit 1
                  echo "All secrets validated"

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Restore news and cache from gh-pages
              run: |
                  git fetch origin gh-pages || true
                  if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
                    git checkout origin/gh-pages -- news cache 2>/dev/null || true
                    if [ -d news ]; then
                      mkdir -p public/news
                      cp -r news/* public/news/
                      echo "Restored news from gh-pages"
                      ls -la public/news/
                    fi
                    echo "Restored cache from gh-pages"
                    ls -la cache/
                  fi

            - name: Clean news
              run: python3 src/frontend/clean_news.py

            - name: Update News
              env:
                  CONTACT_INFO: ${{ secrets.CONTACT_INFO }}
                  LANGUAGE_MODEL_BASE_URL: ${{ secrets.LANGUAGE_MODEL_BASE_URL }}
                  LANGUAGE_MODEL_NAME: ${{ secrets.LANGUAGE_MODEL_NAME }}
                  LANGUAGE_MODEL_API_KEY: ${{ secrets.LANGUAGE_MODEL_API_KEY }}
              run: |
                  python src/backend/run_backend.py

            - name: Deploy to gh-pages
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  mkdir -p /tmp/public-deploy
                  cp -r public/* /tmp/public-deploy/
                  cp -r cache /tmp/public-deploy/ 2>/dev/null || true
                  git checkout --orphan temp-gh-pages
                  git rm -rf .
                  git clean -fd
                  cp -r /tmp/public-deploy/* .
                  git add -A
                  git commit -m "Deploy public to gh-pages"
                  git push -f origin temp-gh-pages:gh-pages
