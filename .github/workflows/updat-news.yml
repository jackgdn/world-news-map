name: Scheduled main.py

on:
    schedule:
        - cron: "0 6,18 * * *"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    run-main:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate required secrets
              env:
                  CONTACT_INFO: ${{ secrets.CONTACT_INFO }}
                  LANGUAGE_MODEL_BASE_URL: ${{ secrets.LANGUAGE_MODEL_BASE_URL }}
                  LANGUAGE_MODEL_NAME: ${{ secrets.LANGUAGE_MODEL_NAME }}
                  LANGUAGE_MODEL_API_KEY: ${{ secrets.LANGUAGE_MODEL_API_KEY }}
              run: |
                  [ -z "$CONTACT_INFO" ] && echo "Missing CONTACT_INFO" && exit 1
                  [ -z "$LANGUAGE_MODEL_BASE_URL" ] && echo "Missing LANGUAGE_MODEL_BASE_URL" && exit 1
                  [ -z "$LANGUAGE_MODEL_NAME" ] && echo "Missing LANGUAGE_MODEL_NAME" && exit 1
                  [ -z "$LANGUAGE_MODEL_API_KEY" ] && echo "Missing LANGUAGE_MODEL_API_KEY" && exit 1

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Clean news
              run: python3 src/frontend/clean_news.py

            - name: Update News
              env:
                  CONTACT_INFO: ${{ secrets.CONTACT_INFO }}
                  LANGUAGE_MODEL_BASE_URL: ${{ secrets.LANGUAGE_MODEL_BASE_URL }}
                  LANGUAGE_MODEL_NAME: ${{ secrets.LANGUAGE_MODEL_NAME }}
                  LANGUAGE_MODEL_API_KEY: ${{ secrets.LANGUAGE_MODEL_API_KEY }}
              run: |
                  python src/backend/run_backend.py

            - name: Commit and push changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add -A
                  git diff --staged --quiet || git commit -m "Update news"
                  git push
